version: "3.9"

services:
    # PostgreSQL Database
    db:
        image: postgres:15-alpine
        container_name: nextops_db
        environment:
            POSTGRES_DB: nextops
            POSTGRES_USER: nextops_user
            POSTGRES_PASSWORD: nextops_password
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U nextops_user -d nextops"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Redis Cache & Message Broker
    redis:
        image: redis:7-alpine
        container_name: nextops_redis
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 5

    # Django Backend
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: nextops_backend
        command: python manage.py runserver 0.0.0.0:8000
        volumes:
            - ./backend:/app
            - ./facturas:/app/facturas
            - media_files:/app/media
            - static_files:/app/staticfiles
        ports:
            - "8000:8000"
        env_file:
            - ./backend/.env
        environment:
            - DATABASE_URL=postgresql://nextops_user:nextops_password@db:5432/nextops
            - REDIS_URL=redis://redis:6379/0
            - DEBUG=True
            - DJANGO_SETTINGS_MODULE=proyecto.settings.dev
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
        restart: unless-stopped

    # # Celery Worker
    # celery:
    #     build:
    #         context: ./backend
    #         dockerfile: Dockerfile
    #     container_name: nextops_celery
    #     command: celery -A workers.celery worker --loglevel=info
    #     environment:
    #         - DATABASE_URL=postgresql://nextops_user:nextops_password@db:5432/nextops
    #         - REDIS_URL=redis://redis:6379/0
    #         - DJANGO_SETTINGS_MODULE=proyecto.settings.dev
    #         - MS_GRAPH_CLIENT_ID=YOUR_CLIENT_ID
    #         - MS_GRAPH_CLIENT_SECRET=YOUR_CLIENT_SECRET
    #         - MS_GRAPH_TENANT_ID=YOUR_TENANT_ID
    #         - MS_GRAPH_USER_EMAIL=YOUR_USER_EMAIL
    #     depends_on:
    #         - db
    #         - redis
    #         - backend
    #     restart: unless-stopped

    # # Celery Beat (Scheduler)
    # celery-beat:
    #     build:
    #         context: ./backend
    #         dockerfile: Dockerfile
    #     container_name: nextops_celery_beat
    #     command: celery -A workers.celery beat --loglevel=info
    #     volumes:
    #         - ./backend:/app
    #     env_file:
    #         - ./backend/.env
    #     environment:
    #         - DATABASE_URL=postgresql://nextops_user:nextops_password@db:5432/nextops
    #         - REDIS_URL=redis://redis:6379/0
    #         - DJANGO_SETTINGS_MODULE=proyecto.settings.dev
    #     depends_on:
    #         - db
    #         - redis
    #         - backend
    #     restart: unless-stopped

volumes:
    postgres_data:
    redis_data:
    media_files:
    static_files:

networks:
    default:
        name: nextops_network
